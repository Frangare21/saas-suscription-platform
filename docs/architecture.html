<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SaaS Subscription Platform - Documentación de Arquitectura</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111a33;
      --text: #e7ecff;
      --muted: #b6c0ff;
      --accent: #7aa2ff;
      --border: rgba(255,255,255,.12);
      --codebg: rgba(255,255,255,.06);
    }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), #070a14);
      color: var(--text);
      line-height: 1.55;
    }
    header, main, footer {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }
    header {
      padding-top: 40px;
    }
    h1, h2, h3 {
      line-height: 1.2;
      margin: 0 0 12px;
    }
    h1 { font-size: 2rem; }
    h2 { font-size: 1.4rem; margin-top: 26px; }
    h3 { font-size: 1.1rem; margin-top: 18px; }
    p { margin: 10px 0; color: var(--text); }
    .muted { color: var(--muted); }
    .panel {
      background: rgba(17, 26, 51, .85);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    code, pre {
      background: var(--codebg);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    code {
      padding: 2px 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95em;
    }
    pre {
      padding: 14px;
      overflow-x: auto;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    ul { margin: 8px 0 8px 22px; }
    li { margin: 6px 0; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .kpi {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(122, 162, 255, .15);
      border: 1px solid rgba(122, 162, 255, .35);
      color: var(--text);
      font-size: .9rem;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    footer { color: var(--muted); font-size: .95rem; padding-bottom: 60px; }
    .toc a { display: inline-block; margin: 4px 10px 4px 0; }
  </style>
</head>
<body>
<header>
  <h1>Documentación técnica — SaaS Subscription Platform</h1>
  <p class="muted">
    Objetivo: que cualquier dev nuevo pueda entender rápido el sistema actual (API Gateway + auth-service + user-service + billing-service + Postgres) y cómo se comunican.
  </p>
  <div class="toc">
    <span class="kpi">Actualizado: 2026-01-23</span>
    <span class="kpi">Estado: base funcional + billing integrado</span>
  </div>
</header>

<main>
  <section class="panel">
    <h2 id="overview">1. Overview</h2>
    <p>
      Este repositorio implementa una plataforma estilo <strong>Stripe/Paddle/MercadoPago para SaaS</strong>.
      El foco es permitir que empresas gestionen usuarios, autenticación y (a futuro) suscripciones, cobros, facturación y notificaciones.
    </p>
    <p>
      En el estado actual ya existe un <strong>API Gateway</strong> que expone HTTP público y proxea requests a servicios internos:
      <code>auth-service</code>, <code>user-service</code> y <code>billing-service</code>. Los datos se guardan en <strong>PostgreSQL</strong>.
    </p>
  </section>

  <section class="panel" style="margin-top:14px;">
    <h2 id="architecture">2. Arquitectura general del sistema</h2>
    <p>Componentes principales actualmente en uso:</p>

    <div class="grid">
      <div class="panel">
        <h3>API Gateway</h3>
        <ul>
          <li>Punto de entrada público (puerto 8080 en compose).</li>
          <li>Valida JWT para rutas protegidas.</li>
          <li>Actúa como reverse proxy hacia auth/user/billing.</li>
          <li>Agrega headers internos (<code>X-Internal-User-ID</code>, <code>X-Internal-Request-ID</code>, <code>X-Internal-Call-Stack</code>).</li>
        </ul>
      </div>

      <div class="panel">
        <h3>Auth Service</h3>
        <ul>
          <li>Registro: hashea password (bcrypt) y crea usuario vía User Service.</li>
          <li>Login: busca usuario por email, valida bcrypt y emite JWT.</li>
          <li>Endpoint <code>/me</code> pensado para consumirse via gateway.</li>
        </ul>
      </div>

      <div class="panel">
        <h3>User Service</h3>
        <ul>
          <li>Persistencia y consultas de usuarios.</li>
          <li>Protegido por header interno (<code>X-Internal-User-ID</code>).</li>
          <li>Conecta a Postgres con <code>pgxpool</code>.</li>
        </ul>
      </div>

      <div class="panel">
        <h3>Billing Service</h3>
        <ul>
          <li>Facturación (MVP): crea y lista <em>invoices</em>.</li>
          <li>Protegido por header interno (<code>X-Internal-User-ID</code>).</li>
          <li>Conecta a Postgres (tabla <code>invoices</code>).</li>
        </ul>
      </div>

      <div class="panel">
        <h3>PostgreSQL</h3>
        <ul>
          <li>Almacenamiento actual: tablas <code>users</code> e <code>invoices</code>.</li>
          <li>Migraciones:
            <ul>
              <li><code>services/user-service/migrations</code></li>
              <li><code>services/billing-service/migrations</code></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>

    <h3>Diagrama lógico (simplificado)</h3>
    <pre><code>Cliente (Web/Mobile)
        |
        v
  API Gateway (HTTP público)
   |          |            |
   v          v            v
Auth Service  User Service  Billing Service
     |             |              |
     v             v              v
  User Service --> Postgres &lt;-- Billing Service</code></pre>

    <p class="muted">
      Nota: dentro del cluster Docker, los servicios se descubren por nombre (ej: <code>http://auth-service:8082</code>, <code>http://user-service:8081</code>, <code>http://billing-service:8083</code>).
    </p>
  </section>

  <section class="panel" style="margin-top:14px;">
    <h2 id="communication">3. Comunicación entre microservicios</h2>

    <h3>3.1 Protocolos</h3>
    <ul>
      <li><strong>HTTP/JSON</strong> entre gateway ↔ servicios y auth ↔ user.</li>
      <li>Timeouts configurados en el cliente HTTP del gateway y del auth-service.</li>
    </ul>

    <h3>3.2 Contrato de rutas (traducción de paths en el Gateway)</h3>
    <p>
      El API Gateway expone rutas con prefijo <code>/api</code> y las convierte a paths internos sin ese prefijo.
    </p>
    <ul>
      <li><code>POST /api/auth/register</code> → <code>POST http://auth-service:8082/register</code></li>
      <li><code>POST /api/auth/login</code> → <code>POST http://auth-service:8082/login</code></li>
      <li><code>GET /api/auth/me</code> → <code>GET http://auth-service:8082/me</code></li>
      <li><code>GET /api/users/email/{email}</code> → <code>GET http://user-service:8081/users/email/{email}</code></li>
      <li><code>GET /api/billing/invoices</code> → <code>GET http://billing-service:8083/invoices</code></li>
      <li><code>POST /api/billing/invoices</code> → <code>POST http://billing-service:8083/invoices</code></li>
    </ul>

    <h3>3.3 Autenticación: JWT + “internal headers”</h3>
    <p>
      La autenticación hacia el cliente final se basa en <strong>JWT</strong>.
      Para comunicación interna (Gateway → servicios internos), se utilizan headers internos para:
      (1) autorizar que la request viene del gateway y (2) habilitar trazabilidad end-to-end.
    </p>
    <ul>
      <li><code>X-Internal-User-ID</code>: señal de request interno confiable (los servicios internos rechazan requests si falta).</li>
      <li><code>X-Internal-Request-ID</code>: correlación end-to-end.</li>
      <li><code>X-Internal-Call-Stack</code>: cadena de hops del request (ej: <code>api-gateway&gt;auth-service&gt;user-service</code>).</li>
    </ul>

    <h3>3.4 Observabilidad (logs de trazabilidad)</h3>
    <p>
      El sistema implementa trazabilidad “liviana” vía logs (sin tracing distribuido completo):
      cada service loguea el comienzo/fin de un request e incluye <code>request_id</code> y <code>call_stack</code>.
    </p>
    <ul>
      <li><strong>auth-service</strong> y <strong>user-service</strong>: <code>request_start</code> / <code>request_end</code></li>
      <li><strong>auth-service</strong> → <strong>user-service</strong>: <code>upstream_call</code> / <code>upstream_call failed</code></li>
    </ul>
    <p class="muted">
      Contrato/Helpers: <code>libs/trace/trace.go</code>
    </p>
  </section>

  <section class="panel" style="margin-top:14px;">
    <h2 id="gateway">4. Rol del API Gateway</h2>

    <p>Actualmente el gateway cumple 4 funciones principales:</p>
    <ul>
      <li><strong>Entry point</strong>: unifica un solo host/puerto para el cliente.</li>
      <li><strong>Routing + reverse proxy</strong>: decide el service destino según path y proxya request/response.</li>
      <li><strong>Auth</strong>: valida JWT en rutas protegidas.</li>
      <li><strong>Contexto para servicios internos</strong>: agrega headers internos (ej: <code>X-Internal-User-ID</code>, <code>X-Internal-Request-ID</code>, <code>X-Internal-Call-Stack</code>).</li>
    </ul>

    <h3>Detalles de implementación relevantes</h3>
    <ul>
      <li>El proxy mapea <code>/api/billing/*</code> → <code>/*</code> antes de reenviar al billing-service.</li>
      <li>Para servicios internos (users/billing), el gateway remueve el header <code>Authorization</code> al reenviar y usa headers internos.</li>
    </ul>
  </section>

  <section class="panel" style="margin-top:14px;">
    <h2 id="database">5. Base de datos (Postgres) y responsabilidades</h2>

    <h3>5.1 Responsabilidad de la base</h3>
    <p>
      Postgres es la fuente de verdad para los datos del dominio. En el estado actual se usa para persistir:
      <strong>usuarios</strong> (user-service) e <strong>invoices</strong> (billing-service).
    </p>

    <h3>5.2 Conexión a Postgres</h3>
    <ul>
      <li><code>user-service</code> conecta vía <code>USER_DB_DSN</code> usando <code>pgxpool</code>.</li>
      <li><code>billing-service</code> conecta vía <code>BILLING_DB_DSN</code> usando <code>database/sql</code> + driver <code>lib/pq</code>.</li>
      <li>En <code>deploy/docker-compose.yml</code> se montan migraciones de ambos servicios en <code>/docker-entrypoint-initdb.d</code>.</li>
    </ul>

    <h3>5.3 Migraciones</h3>
    <p>
      En el primer arranque del contenedor de Postgres (cuando se crea el volumen), se ejecutan scripts SQL de:
    </p>
    <ul>
      <li><code>services/user-service/migrations</code> (tabla <code>users</code>)</li>
      <li><code>services/billing-service/migrations</code> (tabla <code>invoices</code>)</li>
    </ul>
  </section>

  <section class="panel" style="margin-top:14px;">
    <h2 id="services">6. Servicios existentes y endpoints</h2>

    <h3>6.1 API Gateway (público)</h3>
    <ul>
      <li><code>GET /health</code></li>
      <li><code>POST /api/auth/register</code></li>
      <li><code>POST /api/auth/login</code></li>
      <li><code>GET /api/auth/me</code> (JWT)</li>
      <li><code>/api/users/*</code> (JWT)</li>
      <li><code>/api/billing/*</code> (JWT)</li>
    </ul>

    <h3>6.2 Billing Service (interno)</h3>
    <ul>
      <li><code>GET /health</code></li>
      <li><code>POST /invoices</code> (internal header)</li>
      <li><code>GET /invoices</code> (internal header)</li>
    </ul>

    <h3>6.3 Auth Service (interno)</h3>
    <ul>
      <li><code>GET /health</code></li>
      <li><code>POST /register</code></li>
      <li><code>POST /login</code></li>
      <li><code>GET /me</code> (internal header)</li>
    </ul>

    <h3>6.4 User Service (interno)</h3>
    <ul>
      <li><code>GET /health</code></li>
      <li><code>POST /users</code> (internal header)</li>
      <li><code>GET /users/{id}</code> (internal header)</li>
      <li><code>GET /users/email/{email}</code> (internal header)</li>
    </ul>
  </section>

  <section class="panel" style="margin-top:14px;">
    <h2 id="billing">7. Billing service en detalle (MVP)</h2>

    <h3>Flujo “crear invoice”</h3>
    <pre><code>Cliente
  |  POST /api/billing/invoices (Authorization: Bearer ...)
  v
API Gateway
  |  valida JWT
  |  agrega X-Internal-User-ID (+ request id + call stack)
  v
Billing Service
  |  valida X-Internal-User-ID
  |  INSERT en Postgres (invoices)
  v
Respuesta al cliente (via gateway)</code></pre>

    <h3>Notas técnicas</h3>
    <ul>
      <li>Hoy el payload de creación incluye <code>user_id</code> y <code>amount</code>.</li>
      <li>Próxima mejora recomendada: tomar el <code>user_id</code> del JWT (subject) vía header interno y no desde el body.</li>
      <li>Próxima mejora recomendada: evitar <code>float64</code> para dinero.</li>
    </ul>
  </section>

  <section class="panel" style="margin-top:14px;">
    <h2 id="runbook">8. Runbook (levantar el sistema)</h2>

    <ol>
      <li>Crear <code>deploy/.env</code> (ver <code>deploy/README.md</code>).</li>
      <li>Levantar con Docker Compose: <code>docker-compose up -d</code> dentro de <code>deploy/</code>.</li>
      <li>Probar <code>GET http://localhost:8080/health</code>.</li>
      <li>Registrar usuario con <code>POST /api/auth/register</code>.</li>
      <li>Loguear con <code>POST /api/auth/login</code> y usar el token en endpoints protegidos (users y billing).</li>
    </ol>
  </section>

  <section class="panel" style="margin-top:14px;">
    <h2 id="next">9. Próximos pasos recomendados</h2>
    <ul>
      <li>Completar API de invoices (<code>GET /invoices/{id}</code>, filtros, paginado).</li>
      <li>Mejorar modelo de dinero (centavos + moneda).</li>
      <li>Agregar modelo de “empresas/tenants” y “suscripciones/planes”.</li>
      <li>Implementar <code>payment-service</code> con integración a MercadoPago (pagos + webhooks).</li>
      <li>Mejorar auth interna (mTLS o tokens de servicio) y trazabilidad (tracing/metrics).</li>
    </ul>
  </section>
</main>

<footer>
  <p>
    Documento living. La idea es mantenerlo actualizado a medida que se sumen servicios: payment, notifications, subscriptions, webhooks, etc.
  </p>
</footer>
</body>
</html>
